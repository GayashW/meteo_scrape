<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SL // METEO COMMAND</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap');
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#020812;--panel:rgba(2,12,28,0.93);
  --border:rgba(0,255,255,0.22);--border2:rgba(0,255,255,0.07);
  --c1:#00ffff;--c3:#ff00cc;--c4:#7700ff;--c5:#00ff88;
  --hot:#ff3c3c;--cold:#00cfff;--muted:#3a8aaa;--text:#b8e4f4;
  --glow:0 0 8px rgba(0,255,255,.55),0 0 22px rgba(0,255,255,.18);
  --glow3:0 0 8px rgba(255,0,204,.5),0 0 22px rgba(255,0,204,.15);
  --mono:'Share Tech Mono',monospace;--orb:'Orbitron',sans-serif;
  /* timeline height estimate for stacking */
  --tl-h:190px;
}
html,body{width:100%;height:100%;background:var(--bg);color:var(--text);
  font-family:var(--mono);font-size:14px;overflow:hidden}
body::before{content:'';position:fixed;inset:0;z-index:9998;pointer-events:none;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,255,255,.009) 2px,rgba(0,255,255,.009) 4px)}
body::after{content:'';position:fixed;inset:0;z-index:9997;pointer-events:none;
  background:radial-gradient(ellipse at center,transparent 45%,rgba(0,0,0,.65) 100%)}

#map{position:absolute;inset:0;z-index:1}
.leaflet-control-attribution{background:rgba(2,8,18,.85)!important;color:var(--muted)!important;
  font-family:var(--mono)!important;font-size:10px!important}
.leaflet-control-zoom a{background:rgba(0,12,30,.92)!important;color:var(--c1)!important;
  border:1px solid var(--border)!important;font-family:var(--mono)!important;
  box-shadow:var(--glow)!important;width:36px!important;line-height:36px!important;font-size:20px!important}
.leaflet-control-zoom a:hover{background:rgba(0,255,255,.1)!important}

/* ‚îÄ‚îÄ Loading ‚îÄ‚îÄ */
#loading{position:absolute;inset:0;z-index:9999;background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:22px;transition:opacity .6s}
.load-ring{width:80px;height:80px;position:relative}
.load-ring::before,.load-ring::after{content:'';position:absolute;border-radius:50%}
.load-ring::before{inset:0;border:2px solid rgba(0,255,255,.08);animation:sp 3s linear infinite}
.load-ring::after{inset:8px;border:2px solid transparent;border-top-color:var(--c1);border-right-color:var(--c3);
  animation:sp 1.1s linear infinite reverse;filter:drop-shadow(0 0 6px var(--c1))}
@keyframes sp{to{transform:rotate(360deg)}}
.load-txt{font-size:14px;color:var(--c1);letter-spacing:.2em;text-transform:uppercase;animation:blk .8s ease-in-out infinite}
@keyframes blk{0%,100%{opacity:.2}50%{opacity:1}}
.load-bar-w{width:280px;height:2px;background:rgba(0,255,255,.07);overflow:hidden}
.load-bar-i{height:100%;background:linear-gradient(90deg,var(--c4),var(--c1),var(--c3));animation:sc 1.7s ease-in-out infinite}
@keyframes sc{0%{width:0;margin-left:0}50%{width:55%;margin-left:22%}100%{width:0;margin-left:100%}}

/* ‚îÄ‚îÄ HUD base ‚îÄ‚îÄ */
.hud{position:absolute;z-index:1000;background:var(--panel);border:1px solid var(--border);
  backdrop-filter:blur(22px);-webkit-backdrop-filter:blur(22px);
  clip-path:polygon(0 0,calc(100% - 15px) 0,100% 15px,100% 100%,15px 100%,0 calc(100% - 15px))}
.hud::after{content:'';position:absolute;inset:0;pointer-events:none;
  background:linear-gradient(135deg,rgba(0,255,255,.04),transparent 60%)}
.corner{position:absolute;pointer-events:none;z-index:2}
.corner.tl{top:0;left:0;width:22px;height:22px;border-top:1px solid var(--c1);border-left:1px solid var(--c1);box-shadow:var(--glow)}
.corner.br{bottom:0;right:0;width:22px;height:22px;border-bottom:1px solid var(--c1);border-right:1px solid var(--c1);box-shadow:var(--glow)}

/* ‚îÄ‚îÄ Panel collapse ‚îÄ‚îÄ */
.panel-hdr{display:flex;align-items:center;justify-content:space-between;
  height:54px;padding:0 22px;cursor:pointer;user-select:none;border-bottom:1px solid var(--border2)}
.panel-hdr:hover{background:rgba(0,255,255,.03)}
.panel-title{font-size:12px;letter-spacing:.2em;text-transform:uppercase;color:var(--muted)}
.panel-icon{font-size:17px;color:var(--c1);margin-right:10px;opacity:.85}
.min-btn{width:28px;height:28px;background:transparent;border:1px solid var(--border);color:var(--c1);
  font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  clip-path:polygon(0 0,calc(100%-5px) 0,100% 5px,100% 100%,5px 100%,0 calc(100%-5px));transition:all .2s}
.min-btn:hover{background:rgba(0,255,255,.12);box-shadow:var(--glow)}
.panel-body{overflow:hidden;transition:max-height .38s cubic-bezier(.4,0,.2,1),opacity .3s,padding .3s;
  padding:20px 22px}
.panel-body.collapsed{max-height:0!important;opacity:0;padding-top:0;padding-bottom:0}

/* ‚îÄ‚îÄ Typography ‚îÄ‚îÄ */
.lbl{font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);margin-bottom:7px}
.val{font-family:var(--orb);font-size:38px;font-weight:700;line-height:1;color:var(--c1);
  text-shadow:0 0 14px rgba(0,255,255,.45)}
.val.hot{color:var(--hot);text-shadow:0 0 14px rgba(255,60,60,.45)}
.val.cold{color:var(--cold);text-shadow:0 0 14px rgba(0,207,255,.45)}
.val.ok{color:var(--c5);text-shadow:0 0 14px rgba(0,255,136,.35)}
.sub{font-size:12px;color:var(--muted);margin-top:5px}
.hdiv{height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent);margin:17px 0}
.s-row{display:flex;gap:14px}.s-half{flex:1}.s-half .val{font-size:28px}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
#header{top:14px;left:50%;transform:translateX(-50%);height:60px;
  padding:0 34px;display:flex;align-items:center;gap:24px;white-space:nowrap}
.h-logo{font-family:var(--orb);font-size:18px;font-weight:900;letter-spacing:.22em;
  color:var(--c1);text-shadow:0 0 18px var(--c1),0 0 40px rgba(0,255,255,.35);text-transform:uppercase}
.h-sub{font-size:11px;color:var(--muted);letter-spacing:.18em;text-transform:uppercase;margin-top:3px}
.h-sep{width:1px;height:36px;background:linear-gradient(to bottom,transparent,var(--c1),transparent);opacity:.3}
.h-dt{font-size:14px;color:var(--c1);letter-spacing:.1em}
.h-status{display:flex;align-items:center;gap:8px;font-size:12px;letter-spacing:.14em;text-transform:uppercase;color:var(--c5)}
.h-dot{width:9px;height:9px;border-radius:50%;background:var(--c5);box-shadow:0 0 10px var(--c5);
  animation:pd 1.3s ease-in-out infinite}
@keyframes pd{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.3;transform:scale(.6)}}

/* ‚îÄ‚îÄ Side panels ‚îÄ‚îÄ */
#stats{top:90px;left:14px;width:256px}
#controls{top:90px;right:14px;width:240px}
#legend{bottom:168px;right:14px;width:210px}

/* ‚îÄ‚îÄ Toggle buttons ‚îÄ‚îÄ */
.tog{display:flex;gap:6px}
.tbtn{flex:1;padding:12px 6px;background:transparent;border:1px solid var(--border);
  clip-path:polygon(0 0,calc(100%-8px) 0,100% 8px,100% 100%,8px 100%,0 calc(100%-8px));
  color:var(--muted);font-family:var(--mono);font-size:13px;letter-spacing:.07em;cursor:pointer;transition:all .2s}
.tbtn.on{background:rgba(0,255,255,.09);border-color:var(--c1);color:var(--c1);
  box-shadow:inset 0 0 14px rgba(0,255,255,.07),var(--glow)}
.tbtn:hover:not(.on){border-color:rgba(0,255,255,.4);color:var(--text)}

/* ‚îÄ‚îÄ Date buttons ‚îÄ‚îÄ */
.date-row{margin-bottom:11px}
.date-lbl{font-size:11px;letter-spacing:.16em;text-transform:uppercase;color:var(--muted);margin-bottom:7px}
.date-btn{width:100%;padding:12px 15px;background:rgba(0,255,255,.03);
  border:1px solid var(--border);
  clip-path:polygon(0 0,calc(100%-10px) 0,100% 10px,100% 100%,0 100%);
  color:var(--c1);font-family:var(--mono);font-size:14px;letter-spacing:.06em;
  cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:all .2s}
.date-btn:hover{background:rgba(0,255,255,.09);box-shadow:var(--glow);border-color:var(--c1)}
.date-btn .icon{color:var(--muted);font-size:15px;transition:color .2s}
.date-btn:hover .icon{color:var(--c1)}

/* ‚îÄ‚îÄ Download button ‚îÄ‚îÄ */
.dl-btn{width:100%;padding:14px;
  background:linear-gradient(135deg,rgba(0,255,255,.06),rgba(119,0,255,.08));
  border:1px solid rgba(0,255,255,.3);
  clip-path:polygon(0 0,calc(100%-12px) 0,100% 12px,100% 100%,12px 100%,0 calc(100%-12px));
  color:var(--c1);font-family:var(--mono);font-size:14px;letter-spacing:.12em;text-transform:uppercase;
  cursor:pointer;transition:all .22s;display:flex;align-items:center;justify-content:center;gap:10px}
.dl-btn:hover{background:linear-gradient(135deg,rgba(0,255,255,.14),rgba(119,0,255,.16));
  box-shadow:var(--glow);transform:translateY(-1px)}
.dl-sub{font-size:11px;color:var(--muted);text-align:center;margin-top:7px;letter-spacing:.05em}

/* ‚îÄ‚îÄ Legend ‚îÄ‚îÄ */
.leg-bar{height:8px;
  background:linear-gradient(to right,#0040ff,#00cfff,#00ff88,#ffe600,#ff6a00,#ff1a1a);
  margin:10px 0 7px;box-shadow:0 0 12px rgba(0,255,255,.28)}
.leg-lbls{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);letter-spacing:.06em}

/* ‚îÄ‚îÄ Timeline ‚îÄ‚îÄ */
#timeline{bottom:14px;left:50%;transform:translateX(-50%);
  width:min(760px,calc(100vw - 296px));min-width:360px}
.tl-lbl{font-size:12px;letter-spacing:.18em;text-transform:uppercase;color:var(--muted);margin-bottom:5px}
.tl-date{font-family:var(--orb);font-size:18px;font-weight:700;color:var(--c1);
  text-shadow:0 0 14px rgba(0,255,255,.5);letter-spacing:.06em}
.play-btn{width:44px;height:44px;border:none;background:transparent;cursor:pointer;position:relative;flex-shrink:0}
.play-ring{position:absolute;inset:0;border-radius:50%;border:1px solid var(--c1);box-shadow:var(--glow);
  background:rgba(0,255,255,.07);display:flex;align-items:center;justify-content:center;
  font-size:15px;color:var(--c1);transition:all .2s}
.play-btn:hover .play-ring{background:rgba(0,255,255,.18);box-shadow:0 0 24px rgba(0,255,255,.7)}
#tl-slider{width:100%;height:4px;-webkit-appearance:none;appearance:none;
  background:rgba(0,255,255,.09);outline:none;cursor:pointer;margin:6px 0 13px;display:block}
#tl-slider::-webkit-slider-thumb{-webkit-appearance:none;width:20px;height:20px;
  background:var(--c1);box-shadow:0 0 16px var(--c1);cursor:grab;transform:rotate(45deg)}
#tl-slider::-webkit-slider-thumb:active{cursor:grabbing;transform:rotate(45deg) scale(1.4)}
.tl-lbls{display:flex;justify-content:space-between;font-size:11px;color:var(--muted);
  letter-spacing:.06em;margin-bottom:13px}
.chips{display:flex;gap:7px;flex-wrap:wrap}
.chip{padding:8px 16px;background:transparent;border:1px solid var(--border);
  clip-path:polygon(9px 0,100% 0,calc(100%-9px) 100%,0 100%);
  color:var(--muted);font-family:var(--mono);font-size:13px;letter-spacing:.08em;cursor:pointer;transition:all .18s}
.chip.on{background:rgba(0,255,255,.11);border-color:var(--c1);color:var(--c1);box-shadow:var(--glow)}
.chip:hover:not(.on){border-color:rgba(0,255,255,.38);color:var(--text)}

/* ‚îÄ‚îÄ Hover card ‚îÄ‚îÄ */
#hcard{position:absolute;z-index:2000;padding:22px;min-width:220px;pointer-events:none;
  display:none;animation:hpop .13s ease;
  background:rgba(0,8,24,.95);border:1px solid rgba(0,255,255,.4);
  clip-path:polygon(0 0,calc(100%-17px) 0,100% 17px,100% 100%,17px 100%,0 calc(100%-17px));
  box-shadow:0 0 28px rgba(0,255,255,.16)}
@keyframes hpop{from{opacity:0;transform:scale(.93) translateY(4px)}to{opacity:1;transform:scale(1) translateY(0)}}
.hc-corner{position:absolute;top:0;right:0;width:17px;height:17px;
  border-top:1px solid var(--c1);border-right:1px solid var(--c1)}
.hc-station{font-family:var(--orb);font-size:11px;font-weight:700;color:var(--muted);
  letter-spacing:.18em;text-transform:uppercase;margin-bottom:7px}
.hc-temp{font-family:var(--orb);font-size:44px;font-weight:900;line-height:1;margin:6px 0}
.hc-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 14px;
  font-family:var(--mono);font-size:12px;letter-spacing:.14em;text-transform:uppercase;border:1px solid;margin-top:6px}
.hc-div{height:1px;background:linear-gradient(90deg,transparent,rgba(0,255,255,.22),transparent);margin:14px 0}
.hc-row{display:flex;justify-content:space-between;align-items:center;font-size:13px;margin-top:7px;gap:16px}
.hc-lbl{color:var(--muted);letter-spacing:.07em}
.hc-v{color:var(--c1);font-weight:700;font-size:14px}

/* ‚îÄ‚îÄ Custom Calendar ‚îÄ‚îÄ */
#cal-overlay{position:fixed;inset:0;z-index:8000;display:none;
  align-items:center;justify-content:center;
  background:rgba(0,0,0,.78);backdrop-filter:blur(9px)}
#cal-box{background:rgba(2,12,28,.99);border:1px solid var(--c1);
  clip-path:polygon(0 0,calc(100%-22px) 0,100% 22px,100% 100%,22px 100%,0 calc(100%-22px));
  box-shadow:0 0 50px rgba(0,255,255,.22),0 0 100px rgba(0,255,255,.06);
  padding:28px;width:360px;position:relative}
.cal-corner-tl{position:absolute;top:0;left:0;width:26px;height:26px;
  border-top:1px solid var(--c1);border-left:1px solid var(--c1);box-shadow:var(--glow)}
.cal-corner-br{position:absolute;bottom:0;right:0;width:26px;height:26px;
  border-bottom:1px solid var(--c1);border-right:1px solid var(--c1);box-shadow:var(--glow)}
.cal-label{font-size:11px;letter-spacing:.24em;text-transform:uppercase;color:var(--muted);margin-bottom:16px}
.cal-today-row{display:flex;justify-content:flex-end;margin-bottom:12px}
.cal-today-btn{background:transparent;border:1px solid rgba(0,255,255,.25);color:var(--muted);
  font-family:var(--mono);font-size:11px;letter-spacing:.12em;text-transform:uppercase;
  padding:5px 12px;cursor:pointer;transition:all .18s;
  clip-path:polygon(4px 0,100% 0,calc(100%-4px) 100%,0 100%)}
.cal-today-btn:hover{border-color:var(--c1);color:var(--c1);background:rgba(0,255,255,.07)}
.cal-nav-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px}
.cal-nav{background:transparent;border:1px solid var(--border);color:var(--c1);
  width:38px;height:38px;cursor:pointer;font-size:16px;font-family:var(--mono);transition:all .18s;
  clip-path:polygon(0 0,calc(100%-7px) 0,100% 7px,100% 100%,7px 100%,0 calc(100%-7px))}
.cal-nav:hover{background:rgba(0,255,255,.1);box-shadow:var(--glow)}
.cal-month{font-family:var(--orb);font-size:17px;font-weight:700;color:var(--c1);
  letter-spacing:.1em;text-shadow:0 0 14px rgba(0,255,255,.4)}
.cal-dows{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-bottom:8px}
.cal-dow{text-align:center;font-size:11px;letter-spacing:.1em;color:var(--muted);padding:5px 0}
.cal-days{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.cal-day{text-align:center;padding:10px 2px;font-size:14px;cursor:pointer;
  border:1px solid transparent;color:var(--text);transition:all .16s;
  clip-path:polygon(0 0,calc(100%-4px) 0,100% 4px,100% 100%,4px 100%,0 calc(100%-4px))}
.cal-day:hover:not(.empty){border-color:var(--c1);color:var(--c1);background:rgba(0,255,255,.08)}
.cal-day.selected{background:rgba(0,255,255,.2);border-color:var(--c1);color:var(--c1);
  box-shadow:0 0 12px rgba(0,255,255,.3)}
.cal-day.today{border-color:rgba(0,255,136,.5);color:var(--c5)}
.cal-day.today.selected{background:rgba(0,255,136,.15);border-color:var(--c5)}
.cal-day.has-data{color:var(--c1);font-weight:700}
.cal-day.empty{cursor:default;border:none;background:none;color:transparent}
.cal-footer{display:flex;gap:12px;margin-top:22px;padding-top:16px;border-top:1px solid var(--border2)}
.cal-btn{flex:1;padding:13px;background:transparent;border:1px solid var(--border);
  clip-path:polygon(0 0,calc(100%-9px) 0,100% 9px,100% 100%,9px 100%,0 calc(100%-9px));
  color:var(--muted);font-family:var(--mono);font-size:13px;letter-spacing:.14em;
  text-transform:uppercase;cursor:pointer;transition:all .2s}
.cal-btn:hover{border-color:rgba(0,255,255,.4);color:var(--text)}
.cal-btn.primary{border-color:var(--c1);color:var(--c1);background:rgba(0,255,255,.06)}
.cal-btn.primary:hover{background:rgba(0,255,255,.15);box-shadow:var(--glow)}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
#toast{position:absolute;bottom:22px;left:50%;transform:translateX(-50%) translateY(80px);z-index:9000;
  padding:14px 28px;font-size:13px;letter-spacing:.14em;text-transform:uppercase;
  pointer-events:none;white-space:nowrap;
  clip-path:polygon(10px 0,100% 0,calc(100%-10px) 100%,0 100%);
  border:1px solid;transition:transform .38s cubic-bezier(.34,1.56,.64,1)}
#toast.show{transform:translateX(-50%) translateY(0)}
.idw-canvas{pointer-events:none;position:absolute;filter:blur(16px)}
#ticker{position:absolute;top:0;left:0;right:0;height:1px;z-index:900;
  background:linear-gradient(90deg,transparent,var(--c1),var(--c3),transparent);
  opacity:.3;animation:tkr 4s linear infinite alternate}
@keyframes tkr{from{transform:translateX(-30%)}to{transform:translateX(30%)}}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MOBILE legend strip (always visible above timeline)
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
#legend-mobile{
  display:none;
  position:absolute;
  bottom:calc(var(--tl-h) + 60px); /* above timeline + mob-bar */
  left:8px;right:8px;
  z-index:1001;
  background:rgba(2,12,28,.92);
  border:1px solid var(--border);
  clip-path:polygon(0 0,calc(100% - 10px) 0,100% 10px,100% 100%,10px 100%,0 calc(100% - 10px));
  padding:10px 16px;
}
#legend-mobile .leg-bar{height:7px;margin:6px 0 5px}
#legend-mobile .leg-ttl{font-size:11px;letter-spacing:.2em;text-transform:uppercase;color:var(--muted)}
#legend-mobile .leg-lbls{font-size:11px}

/* ‚îÄ‚îÄ Mobile floating panel buttons ‚îÄ‚îÄ */
#mob-bar{
  display:none;
  position:absolute;
  bottom:calc(var(--tl-h) + 14px); /* directly above timeline */
  left:8px;
  z-index:1001;
  flex-direction:row;
  gap:8px;
}
.mob-btn{width:48px;height:48px;background:rgba(2,12,28,.92);border:1px solid var(--border);
  clip-path:polygon(0 0,calc(100%-9px) 0,100% 9px,100% 100%,9px 100%,0 calc(100%-9px));
  color:var(--c1);font-size:19px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  box-shadow:var(--glow);transition:all .2s}
.mob-btn:hover,.mob-btn.active{background:rgba(0,255,255,.14);border-color:var(--c1)}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RESPONSIVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media(max-width:980px){
  #timeline{width:calc(100vw - 200px)}
}
@media(max-width:700px){
  #header{top:8px;height:52px;padding:0 18px;gap:14px}
  .h-logo{font-size:15px;letter-spacing:.16em}
  .h-sub,.h-sep:last-of-type{display:none}
  .h-dt{font-size:13px}
  #stats{top:72px;left:8px;width:220px}
  #controls{top:72px;right:8px;width:208px}
  /* Hide desktop legend on mobile */
  #legend{display:none!important}
  /* Show mobile legend strip */
  #legend-mobile{display:block}
  /* Show mob-bar */
  #mob-bar{display:flex}
  /* Timeline full width */
  #timeline{bottom:8px;left:8px;right:8px;transform:none;width:auto;min-width:0}
  .val{font-size:32px}
  .s-half .val{font-size:24px}
  .lbl{font-size:12px}
  .sub{font-size:12px}
}
@media(max-width:460px){
  #stats,#controls{display:none}
  #mob-bar{display:flex}
  .h-logo{font-size:13px}
}
</style>
</head>
<body>
<div id="ticker"></div>

<!-- Loading -->
<div id="loading">
  <div style="font-family:var(--orb);font-size:11px;letter-spacing:.32em;color:var(--muted);text-transform:uppercase;margin-bottom:8px">Atmospheric Command System</div>
  <div class="load-ring"></div>
  <div class="load-bar-w"><div class="load-bar-i"></div></div>
  <div class="load-txt" id="load-msg">INITIALISING‚Ä¶</div>
</div>

<div id="map"></div>
<div id="hcard"><div class="hc-corner"></div></div>
<div id="toast"></div>

<!-- Header -->
<div id="header" class="hud">
  <div class="corner tl"></div><div class="corner br"></div>
  <div>
    <div class="h-logo">SL // METEO</div>
    <div class="h-sub">Atmospheric Command System</div>
  </div>
  <div class="h-sep"></div>
  <div>
    <div style="font-size:11px;letter-spacing:.18em;color:var(--muted);text-transform:uppercase;margin-bottom:3px">Active Feed</div>
    <div class="h-dt" id="hdt">‚Äî</div>
  </div>
  <div class="h-sep"></div>
  <div class="h-status"><div class="h-dot" id="h-dot"></div><span id="h-src">LIVE</span></div>
</div>

<!-- Stats -->
<div id="stats" class="hud">
  <div class="corner tl"></div><div class="corner br"></div>
  <div class="panel-hdr" onclick="togglePanel('stats')">
    <div style="display:flex;align-items:center"><span class="panel-icon">‚óà</span><span class="panel-title">Atmospheric Data</span></div>
    <button class="min-btn" id="stats-min">‚àí</button>
  </div>
  <div class="panel-body" id="stats-body" style="max-height:340px">
    <div class="lbl">Avg Temperature</div>
    <div class="val ok" id="s-avg">‚Äî</div>
    <div class="sub" id="s-avg-sub">across active stations</div>
    <div class="hdiv"></div>
    <div class="lbl">Active Nodes</div>
    <div class="val" id="s-cnt" style="font-size:28px">‚Äî</div>
    <div class="sub" id="s-cnt-sub">stations online</div>
    <div class="hdiv"></div>
    <div class="s-row">
      <div class="s-half">
        <div class="lbl">Min</div>
        <div class="val cold" id="s-min">‚Äî</div>
        <div class="sub" id="s-min-n" style="word-break:break-word">‚Äî</div>
      </div>
      <div class="s-half">
        <div class="lbl">Max</div>
        <div class="val hot" id="s-max">‚Äî</div>
        <div class="sub" id="s-max-n" style="word-break:break-word">‚Äî</div>
      </div>
    </div>
    <div style="font-size:11px;color:var(--muted);opacity:.3;letter-spacing:.1em;margin-top:16px;border-top:1px solid var(--border2);padding-top:8px">SYS // METEO-CMD v5.0</div>
  </div>
</div>

<!-- Controls -->
<div id="controls" class="hud">
  <div class="corner tl"></div><div class="corner br"></div>
  <div class="panel-hdr" onclick="togglePanel('controls')">
    <div style="display:flex;align-items:center"><span class="panel-icon">‚öô</span><span class="panel-title">Control Matrix</span></div>
    <button class="min-btn" id="controls-min">‚àí</button>
  </div>
  <div class="panel-body" id="controls-body" style="max-height:400px">
    <div class="lbl" style="margin-bottom:10px">Display Mode</div>
    <div class="tog">
      <button class="tbtn on" id="btn-heat" onclick="setView('heatmap')">‚óà HEAT</button>
      <button class="tbtn" id="btn-pin" onclick="setView('markers')">‚óâ NODES</button>
    </div>
    <div class="hdiv"></div>
    <div class="lbl">Date Filter Range</div>
    <div class="date-row">
      <div class="date-lbl">From</div>
      <button class="date-btn" onclick="openCal('from')">
        <span id="date-from-txt">‚Äî</span><span class="icon">‚ñ¶</span>
      </button>
    </div>
    <div class="date-row" style="margin-bottom:0">
      <div class="date-lbl">To</div>
      <button class="date-btn" onclick="openCal('to')">
        <span id="date-to-txt">‚Äî</span><span class="icon">‚ñ¶</span>
      </button>
    </div>
    <div class="hdiv"></div>
    <!-- Download exports only date-range-filtered data -->
    <button class="dl-btn" onclick="downloadCSV()">‚¨á EXPORT FILTERED DATA</button>
    <div class="dl-sub" id="dl-sub">‚Äî records in selected range</div>
  </div>
</div>

<!-- Desktop Legend -->
<div id="legend" class="hud">
  <div class="corner tl"></div><div class="corner br"></div>
  <div class="panel-hdr" onclick="togglePanel('legend')">
    <div style="display:flex;align-items:center"><span class="panel-icon">üå°</span><span class="panel-title">Temp Scale ¬∞C</span></div>
    <button class="min-btn" id="legend-min">‚àí</button>
  </div>
  <div class="panel-body" id="legend-body" style="max-height:100px">
    <div class="leg-bar"></div>
    <div class="leg-lbls"><span>15¬∞</span><span>22¬∞</span><span>28¬∞</span><span>34¬∞</span><span>40¬∞</span></div>
  </div>
</div>

<!-- Mobile Legend strip (always above timeline) -->
<div id="legend-mobile">
  <div class="leg-ttl">// Temp Scale ¬∞C &nbsp; 15¬∞ ‚Üí 40¬∞</div>
  <div class="leg-bar"></div>
  <div class="leg-lbls"><span>15¬∞</span><span>20¬∞</span><span>25¬∞</span><span>30¬∞</span><span>35¬∞</span><span>40¬∞</span></div>
</div>

<!-- Timeline -->
<div id="timeline" class="hud">
  <div class="corner tl"></div><div class="corner br"></div>
  <div class="panel-body" style="max-height:240px;padding:20px 24px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div>
        <div class="tl-lbl">// Timeline Navigator</div>
        <div class="tl-date" id="tl-date">‚Äî</div>
      </div>
      <button class="play-btn" onclick="togglePlay()">
        <div class="play-ring" id="play-ring">‚ñ∂</div>
      </button>
    </div>
    <input type="range" id="tl-slider" min="0" max="0" value="0" oninput="onSlide(+this.value)">
    <div class="tl-lbls" id="tl-lbls"></div>
    <div class="chips" id="chips"></div>
  </div>
</div>

<!-- Mobile panel toggle buttons ‚Äî sit above timeline -->
<div id="mob-bar">
  <button class="mob-btn" id="mob-stats"    onclick="mobToggle('stats')"    title="Stats">‚óà</button>
  <button class="mob-btn" id="mob-controls" onclick="mobToggle('controls')" title="Controls">‚öô</button>
</div>

<!-- Calendar overlay -->
<div id="cal-overlay" onclick="calOverlayClick(event)">
  <div id="cal-box">
    <div class="cal-corner-tl"></div><div class="cal-corner-br"></div>
    <div class="cal-label" id="cal-label">SELECT DATE</div>
    <div class="cal-today-row">
      <button class="cal-today-btn" onclick="jumpToToday()">‚ñ∏ TODAY</button>
    </div>
    <div class="cal-nav-row">
      <button class="cal-nav" onclick="navCal(-1)">‚óÄ</button>
      <div class="cal-month" id="cal-month">‚Äî</div>
      <button class="cal-nav" onclick="navCal(1)">‚ñ∂</button>
    </div>
    <div class="cal-dows" id="cal-dows"></div>
    <div class="cal-days" id="cal-days"></div>
    <div class="cal-footer">
      <button class="cal-btn" onclick="closeCal()">CANCEL</button>
      <button class="cal-btn primary" onclick="confirmCal()">CONFIRM</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODULE: data.js
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DATA_URL='https://raw.githubusercontent.com/GayashW/meteo_scrape/main/docs/data.xlsx';
const SL_STATIONS={
  'POLONNARUWA':[7.9403,81.0188],'MAHA ILLUPPALLAMA':[8.1167,80.4833],
  'BADULLA':[6.9934,81.0550],'VAVUNIYA':[8.7514,80.4979],
  'MONARAGALA':[6.8728,81.3507],'MULLATIVU':[9.2671,80.8128],
  'BANDARAWELA':[6.8300,81.0000],'POTTUVIL':[6.8667,81.8333],
  'JAFFNA':[9.6615,80.0255],'GALLE':[6.0535,80.2210],
  'NUWARA ELIYA':[6.9497,80.7891],'RATMALANA':[6.8214,79.8869],
  'ANURADHAPURA':[8.3114,80.4037],'KATUGASTOTA':[7.3500,80.6333],
  'KATUNAYAKE':[7.1696,79.8864],'HAMBANTOTA':[6.1241,81.1185],
  'COLOMBO':[6.9271,79.8612],'MANNAR':[8.9811,79.9044],
  'TRINCOMALEE':[8.5874,81.2152],'BATTICALOA':[7.7310,81.6747],
  'KURUNEGALA':[7.4863,80.3647],'RATNAPURA':[6.6828,80.3992],
  'MATTALA':[6.2833,81.1000],'PUTTALAM':[8.0362,79.8283],
  'KANDY':[7.2906,80.6337],
};
const WX_MAP={
  cloudy:'CLOUDY',fairday:'CLEAR',fairnight:'CLEAR-NIGHT',
  partlycloudy:'PARTLY CLOUDY',partlycloudynight:'PARTLY CLOUDY',
  drizzling:'DRIZZLE',showers:'SHOWERS',mist:'MIST',
  hazenight:'HAZE',fog:'FOG',thunder:'STORM',rain:'RAIN',sunny:'SUNNY',
};
const FALLBACK_CSV=`Station_ID,Station_Name,Report_Time,Rainfall (mm),Tot RF since 830am,Temperature ( C ),RH (%),weathertype
721501,POLONNARUWA,2025-12-27 1730,0,9.8,26,92,cloudy
43422,MAHA ILLUPPALLAMA,2025-12-27 1730,0,0.0,26,79,cloudy
43479,BADULLA,2025-12-27 1730,0,0.2,20.2,94,cloudy
43415,VAVUNIYA,2025-12-27 1730,0,0.0,27,78,fairday
821501,MONARAGALA,2025-12-27 1730,0,0.5,22.1,89,cloudy
43410,MULLATIVU,2025-12-27 1730,0,0.0,27.3,77,partlycloudy
43476,BANDARAWELA,2025-12-27 2030,0,TR,17.4,100,drizzling
43475,POTTUVIL,2025-12-27 2030,0,0.7,24.6,95,showers
43404,JAFFNA,2025-12-27 2030,0,0.0,24.8,84,partlycloudynight
43495,GALLE,2025-12-27 2330,0,0.0,25.1,86,fairnight
43473,NUWARA ELIYA,2025-12-27 2330,0,0.0,20,94,partlycloudynight
43467,RATMALANA,2025-12-27 2330,0,0.0,27,73,partlycloudynight
43421,ANURADHAPURA,2025-12-27 2330,0,TR,23.7,91,fairnight
43444,KATUGASTOTA,2025-12-27 2330,0,0.0,21.2,91,fairnight
43450,KATUNAYAKE,2025-12-27 2330,0,0.0,24.8,85,fairnight
43497,HAMBANTOTA,2025-12-27 2330,0,0.0,25.2,89,fairnight
43466,COLOMBO,2025-12-27 2330,0,0.0,26.3,74,partlycloudynight
43413,MANNAR,2025-12-27 2330,0,0.0,26.1,85,partlycloudynight
43418,TRINCOMALEE,2025-12-27 2330,0,0.2,26,82,fairnight
43436,BATTICALOA,2025-12-27 2330,0,TR,26.8,83,cloudy
43441,KURUNEGALA,2025-12-27 2330,0,TR,24.6,82,fairnight
43486,RATNAPURA,2025-12-27 2330,0,0.0,23.9,90,mist
330601,MATTALA,2025-12-27 2330,0,0.0,24,91,fairnight
43424,PUTTALAM,2025-12-27 2330,0,0.0,24.6,88,fairnight
43473,NUWARA ELIYA,2025-12-28 0230,0,0.0,15,97,cloudy
43450,KATUNAYAKE,2025-12-28 0230,0,0.0,24.2,88,hazenight
43441,KURUNEGALA,2025-12-28 0230,0,TR,22.9,91,fairnight
43418,TRINCOMALEE,2025-12-28 0230,0,0.2,25.4,85,fairnight
43444,KATUGASTOTA,2025-12-28 0230,0,0.0,20.1,94,fairnight
330601,MATTALA,2025-12-28 0230,0,0.0,24,88,fairnight
43467,RATMALANA,2025-12-28 0230,0,0.0,25.6,79,fairnight
43424,PUTTALAM,2025-12-28 0230,0,0.0,23.5,94,fairnight
43413,MANNAR,2025-12-28 0230,0,0.0,25.6,87,fairnight
43436,BATTICALOA,2025-12-28 0230,0,TR,26.4,87,partlycloudynight
43466,COLOMBO,2025-12-28 0230,0,0.0,25.3,79,fairnight
43421,ANURADHAPURA,2025-12-28 0230,0,TR,22.8,95,fairnight
43497,HAMBANTOTA,2025-12-28 0230,0,0.0,24.7,90,fairnight`;

let RAW=[],DATES=[],TIMES=[],curDate=null,curTime=null,filterFrom=null,filterTo=null;

const findCol=(keys,pats)=>{const lk=keys.map(k=>k.toLowerCase().trim());for(const p of pats){const i=lk.findIndex(k=>k.includes(p));if(i>=0)return keys[i];}return null;};
function resolveCoords(n){const u=n.trim().toUpperCase();for(const[k,v]of Object.entries(SL_STATIONS)){if(u===k||u.includes(k)||k.includes(u))return v;}return null;}
function deriveWeather(t,r){if(!isNaN(r)&&r>1)return'RAINY';if(isNaN(t))return'UNKNOWN';return t>=36?'SCORCHING':t>=32?'HOT':t>=27?'WARM':t>=22?'MILD':'COOL';}

function normalizeRow(station,dateRaw,timeRaw,temp,humidity,wind,rain,pressure,wxRaw){
  let date=(dateRaw||'').trim();
  if(date.includes('/')){const p=date.split('/');if(p.length===3){const y=p[2].length===4?p[2]:'20'+p[2];date=`${y}-${p[0].padStart(2,'0')}-${p[1].padStart(2,'0')}`;}}
  let time=(timeRaw||'').trim();
  if(time&&!time.includes(':')&&time.length===4)time=time.slice(0,2)+':'+time.slice(2);
  else if(time&&!/[:\-]/.test(time))time=String(parseInt(time)).padStart(2,'0')+':00';
  const t=parseFloat(temp),rh=parseFloat(humidity),ws=parseFloat(wind);
  const rf=typeof rain==='string'&&rain.trim().toUpperCase()==='TR'?0.05:parseFloat(rain);
  const pr=parseFloat(pressure);
  const wx=(wxRaw||'').toLowerCase().trim();
  const coords=resolveCoords(station);
  return{station:station.trim(),date,time,
    temp:isNaN(t)?null:t,humidity:isNaN(rh)?null:rh,wind:isNaN(ws)?null:ws,
    rain:isNaN(rf)?null:rf,pressure:isNaN(pr)?null:pr,
    weatherType:WX_MAP[wx]||(wx?wx.toUpperCase():deriveWeather(t,rf)),
    lat:coords?coords[0]:null,lng:coords?coords[1]:null};
}
function parseFallbackCSV(csv){
  const lines=csv.trim().split('\n');
  const hdr=lines[0].split(',').map(h=>h.trim().toLowerCase());
  const ci=p=>hdr.findIndex(h=>h.includes(p));
  const iName=ci('station_name'),iTime=ci('report_time'),iTemp=ci('temperature'),
        iRH=ci('rh'),iRain=ci('rainfall'),iWX=ci('weathertype');
  return lines.slice(1).map(line=>{
    const f=line.split(',');
    const name=(f[iName]||'').trim();
    const[dp,tp]=((f[iTime]||'').trim()).split(' ');
    return normalizeRow(name,dp,tp,f[iTemp],f[iRH],null,f[iRain],null,f[iWX]);
  }).filter(r=>r.station);
}
function parseExcelRows(rows){
  const keys=Object.keys(rows[0]);
  const C={
    station:findCol(keys,['station_name','station','name','location']),
    date:findCol(keys,['date','dt']),time:findCol(keys,['report_time','time','hour']),
    temp:findCol(keys,['temperature','temp','tmp']),humidity:findCol(keys,['rh','humid']),
    wind:findCol(keys,['wind','wspd','speed']),rain:findCol(keys,['rainfall','rain','precip']),
    pressure:findCol(keys,['press','baro','slp']),weather:findCol(keys,['weathertype','weather','wx']),
  };
  return rows.map(r=>{
    const name=C.station?String(r[C.station]??'').trim():'';
    let dv=C.date?String(r[C.date]??'').trim():'';
    let tv=C.time?String(r[C.time]??'').trim():'';
    if(!dv&&tv.includes(' ')){[dv,tv]=tv.split(' ');}
    else if(dv.includes(' ')&&!tv){[dv,tv]=dv.split(' ');}
    return normalizeRow(name,dv,tv,r[C.temp],r[C.humidity],r[C.wind],r[C.rain],r[C.pressure],r[C.weather]);
  }).filter(r=>r.station);
}
async function fetchData(){
  let usedFallback=false;
  try{
    setMsg('CONNECTING TO DATA NODE‚Ä¶');
    const resp=await fetch(DATA_URL);
    if(!resp.ok)throw new Error('HTTP '+resp.status);
    setMsg('PARSING WORKBOOK‚Ä¶');
    const ab=await resp.arrayBuffer();
    const wb=XLSX.read(new Uint8Array(ab),{type:'array',cellDates:true});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{raw:false,dateNF:'yyyy-mm-dd'});
    if(!rows.length)throw new Error('Empty workbook');
    RAW=parseExcelRows(rows);
    if(!RAW.length)throw new Error('No parseable rows');
  }catch(err){
    console.warn('[METEO] Live fetch failed:',err.message);
    usedFallback=true;
    setMsg('LOADING EMBEDDED DATASET‚Ä¶');
    RAW=parseFallbackCSV(FALLBACK_CSV);
  }
  DATES=[...new Set(RAW.map(r=>r.date).filter(Boolean))].sort();
  TIMES=[...new Set(RAW.map(r=>r.time).filter(Boolean))].sort();
  // Start at LATEST date + time
  if(DATES.length){curDate=DATES[DATES.length-1];filterFrom=DATES[0];filterTo=DATES[DATES.length-1];}
  if(TIMES.length)curTime=TIMES[TIMES.length-1];
  return usedFallback;
}

// Current view snapshot
function getSnapshot(){
  const seen={};
  RAW.forEach(r=>{
    if(curDate&&r.date!==curDate)return;
    if(curTime&&r.time&&r.time!==curTime)return;
    if(!seen[r.station]||r.time>(seen[r.station].time??''))seen[r.station]=r;
  });
  return Object.values(seen).filter(r=>r.lat!==null);
}

// Filtered range data ‚Äî respects filterFrom / filterTo
const getFilteredData=()=>RAW.filter(r=>
  (!filterFrom||r.date>=filterFrom)&&(!filterTo||r.date<=filterTo));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODULE: map.js
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const T_MIN=15,T_MAX=40;
let mapObj,markersLG,idwL,viewMode='heatmap';

function t2c(temp){
  const t=Math.max(0,Math.min(1,(temp-T_MIN)/(T_MAX-T_MIN)));
  const stops=[[0,64,255],[0,207,255],[0,255,136],[234,179,8],[255,106,0],[255,26,26]];
  const p=t*(stops.length-1),i=Math.min(Math.floor(p),stops.length-2),f=p-i;
  const[a,b]=[stops[i],stops[i+1]];
  return[a[0]+f*(b[0]-a[0]),a[1]+f*(b[1]-a[1]),a[2]+f*(b[2]-a[2]),160].map(Math.round);
}
const IDWLayer=L.Layer.extend({
  _pts:[],
  onAdd(map){
    this._map=map;this._cvs=document.createElement('canvas');
    this._cvs.className='idw-canvas';
    map.getPanes().overlayPane.appendChild(this._cvs);
    map.on('movestart',()=>{this._cvs.style.opacity='0';},this);
    map.on('moveend zoomend resize',this._reset,this);
    this._reset();requestAnimationFrame(()=>{this._cvs.style.opacity='.85';});
  },
  onRemove(map){
    this._cvs.style.opacity='0';
    setTimeout(()=>this._cvs.parentNode?.removeChild(this._cvs),400);
    map.off('movestart moveend zoomend resize',null,this);
  },
  update(pts){this._pts=pts;this._reset();},
  _reset(){
    const m=this._map,sz=m.getSize();
    L.DomUtil.setPosition(this._cvs,m.containerPointToLayerPoint([0,0]));
    this._cvs.width=sz.x;this._cvs.height=sz.y;
    this._draw(sz);requestAnimationFrame(()=>{this._cvs.style.opacity='.85';});
  },
  _draw({x:W,y:H}){
    const m=this._map,ctx=this._cvs.getContext('2d');
    ctx.clearRect(0,0,W,H);
    const pts=this._pts.filter(s=>s.temp!==null&&s.lat!==null).map(s=>{
      const p=m.latLngToContainerPoint([s.lat,s.lng]);return{x:p.x,y:p.y,v:s.temp};
    });
    if(!pts.length)return;
    const STEP=6,img=ctx.createImageData(W,H),d=img.data;
    for(let y=0;y<H;y+=STEP)for(let x=0;x<W;x+=STEP){
      let ws=0,vs=0;
      for(const p of pts){const dx=x-p.x,dy=y-p.y,d2=dx*dx+dy*dy;if(d2<1){vs=p.v;ws=1;break;}const w=1/d2;ws+=w;vs+=w*p.v;}
      const[r,g,b,a]=t2c(vs/ws);
      for(let sy=0;sy<STEP&&y+sy<H;sy++)for(let sx=0;sx<STEP&&x+sx<W;sx++){const idx=((y+sy)*W+(x+sx))*4;d[idx]=r;d[idx+1]=g;d[idx+2]=b;d[idx+3]=a;}
    }
    ctx.putImageData(img,0,0);
  }
});
function mkIcon(temp){
  const[r,g,b]=temp!==null?t2c(temp):[42,106,138];
  const col=`rgb(${r},${g},${b})`;
  return L.divIcon({className:'',iconSize:[18,18],iconAnchor:[9,9],
    html:`<div style="width:18px;height:18px;transform:rotate(45deg);background:${col};
      border:2px solid rgba(255,255,255,.92);box-shadow:0 0 14px ${col},0 0 5px rgba(0,0,0,.8);cursor:pointer"></div>`});
}
function initMap(){
  mapObj=L.map('map',{center:[7.87,80.77],zoom:8,zoomControl:false});
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
    {attribution:'¬© OpenStreetMap ¬© CARTO',subdomains:'abcd',maxZoom:19}).addTo(mapObj);
  L.control.zoom({position:'bottomright'}).addTo(mapObj);
  markersLG=L.layerGroup().addTo(mapObj);
  idwL=new IDWLayer();
}
function updateMap(stations){
  markersLG.clearLayers();
  if(viewMode==='heatmap'){
    if(!mapObj.hasLayer(idwL))idwL.addTo(mapObj);
    idwL.update(stations);
  }else{
    if(mapObj.hasLayer(idwL))mapObj.removeLayer(idwL);
  }
  stations.forEach(s=>{
    if(s.lat===null)return;
    const mk=L.marker([s.lat,s.lng],{icon:mkIcon(s.temp)});
    mk.on('mouseover',e=>showCard(e.originalEvent,s));
    mk.on('mousemove',e=>moveCard(e.originalEvent));
    mk.on('mouseout',hideCard);
    markersLG.addLayer(mk);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODULE: calendar.js
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MONTHS=['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE','JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];
const DOWS=['SUN','MON','TUE','WED','THU','FRI','SAT'];
let calTarget=null,calYear,calMonth,calPending=null;
let calFrom='',calTo='';
const todayStr=()=>{const d=new Date();return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;};

function openCal(target){
  calTarget=target;
  calPending=(target==='from'&&calFrom)?calFrom:(target==='to'&&calTo)?calTo:todayStr();
  const sel=new Date(calPending+'T00:00:00');
  calYear=sel.getFullYear();calMonth=sel.getMonth();
  $id('cal-label').textContent=target==='from'?'// SELECT FROM DATE':'// SELECT TO DATE';
  renderCal();
  $id('cal-overlay').style.display='flex';
}
function jumpToToday(){
  const t=new Date();calYear=t.getFullYear();calMonth=t.getMonth();calPending=todayStr();renderCal();
}
function closeCal(){$id('cal-overlay').style.display='none';}
function calOverlayClick(e){if(e.target===e.currentTarget)closeCal();}
function navCal(dir){calMonth+=dir;if(calMonth>11){calMonth=0;calYear++;}else if(calMonth<0){calMonth=11;calYear--;}renderCal();}
function renderCal(){
  $id('cal-month').textContent=MONTHS[calMonth]+' '+calYear;
  $id('cal-dows').innerHTML=DOWS.map(d=>`<div class="cal-dow">${d}</div>`).join('');
  const firstDay=new Date(calYear,calMonth,1).getDay();
  const daysInMonth=new Date(calYear,calMonth+1,0).getDate();
  const tStr=todayStr();
  let html='';
  for(let i=0;i<firstDay;i++)html+=`<div class="cal-day empty"></div>`;
  for(let d=1;d<=daysInMonth;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    html+=`<div class="cal-day${ds===calPending?' selected':''}${ds===tStr?' today':''}${DATES.includes(ds)?' has-data':''}"
      onclick="pickDay('${ds}')">${d}</div>`;
  }
  $id('cal-days').innerHTML=html;
}
function pickDay(ds){
  calPending=ds;
  document.querySelectorAll('#cal-days .cal-day:not(.empty)').forEach((el,i)=>{
    const d=i+1,ds2=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    el.classList.toggle('selected',ds2===calPending);
  });
}
function confirmCal(){
  if(!calPending){closeCal();return;}
  if(calTarget==='from'){calFrom=filterFrom=calPending;$id('date-from-txt').textContent=calFrom;}
  else{calTo=filterTo=calPending;$id('date-to-txt').textContent=calTo;}
  updateDlSub();
  closeCal();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODULE: ui.js
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const $id=id=>document.getElementById(id);
const hcard=$id('hcard');
let playing=false,playTmr=null;
const WX_COL={
  'CLOUDY':'#94a3b8','CLEAR':'#fbbf24','CLEAR-NIGHT':'#818cf8',
  'PARTLY CLOUDY':'#7dd3fc','DRIZZLE':'#60a5fa','SHOWERS':'#3b82f6',
  'MIST':'#cbd5e1','HAZE':'#a3a3a3','FOG':'#9ca3af','STORM':'#a855f7',
  'RAIN':'#2563eb','SUNNY':'#f59e0b','SCORCHING':'#ef4444',
  'HOT':'#f97316','WARM':'#eab308','MILD':'#22c55e','COOL':'#00cfff','RAINY':'#3b82f6',
};

function showCard(e,s){
  const[r,g,b]=s.temp!==null?t2c(s.temp):[42,106,138];
  const tc=`rgb(${r},${g},${b})`;const bc=WX_COL[s.weatherType]||'#2a7a9a';
  hcard.innerHTML=`<div class="hc-corner"></div>
    <div class="hc-station">${s.station}</div>
    <div class="hc-temp" style="color:${tc};text-shadow:0 0 20px ${tc}80;font-family:'Orbitron',sans-serif">
      ${s.temp!==null?s.temp.toFixed(1)+'¬∞':'‚Äî'}</div>
    <div class="hc-badge" style="color:${bc};border-color:${bc}55;background:${bc}1a">‚óà ${s.weatherType||'‚Äî'}</div>
    ${(s.humidity!==null||s.wind!==null||s.rain!==null||s.pressure!==null)?`
    <div class="hc-div"></div>
    ${s.humidity!==null?`<div class="hc-row"><span class="hc-lbl">// HUMIDITY</span><span class="hc-v">${s.humidity.toFixed(0)}%</span></div>`:''}
    ${s.wind!==null?`<div class="hc-row"><span class="hc-lbl">// WIND</span><span class="hc-v">${s.wind.toFixed(1)} km/h</span></div>`:''}
    ${s.rain!==null?`<div class="hc-row"><span class="hc-lbl">// RAINFALL</span><span class="hc-v">${s.rain.toFixed(1)} mm</span></div>`:''}
    ${s.pressure!==null?`<div class="hc-row"><span class="hc-lbl">// PRESSURE</span><span class="hc-v">${s.pressure.toFixed(0)} hPa</span></div>`:''}`:''} `;
  hcard.style.display='block';moveCard(e);
}
function moveCard(e){
  hcard.style.left=Math.min(e.clientX+18,window.innerWidth-230)+'px';
  hcard.style.top=Math.max(e.clientY-28,8)+'px';
}
function hideCard(){hcard.style.display='none';}

function updateStats(stations){
  const wt=stations.filter(s=>s.temp!==null);
  $id('s-cnt').textContent=wt.length;
  $id('s-cnt-sub').textContent=`of ${Object.keys(SL_STATIONS).length} nodes total`;
  if(!wt.length){['s-avg','s-min','s-max'].forEach(id=>$id(id).textContent='‚Äî');['s-min-n','s-max-n'].forEach(id=>$id(id).textContent='‚Äî');return;}
  const temps=wt.map(s=>s.temp);
  const avg=temps.reduce((a,b)=>a+b,0)/temps.length;
  const mn=Math.min(...temps),mx=Math.max(...temps);
  $id('s-avg').textContent=avg.toFixed(1)+'¬∞C';
  $id('s-avg').className='val '+(avg>=32?'hot':avg<=23?'cold':'ok');
  $id('s-min').textContent=mn.toFixed(1)+'¬∞';
  $id('s-max').textContent=mx.toFixed(1)+'¬∞';
  $id('s-min-n').textContent=wt.find(s=>s.temp===mn)?.station??'‚Äî';
  $id('s-max-n').textContent=wt.find(s=>s.temp===mx)?.station??'‚Äî';
}
function updateDT(){
  $id('hdt').textContent=[curDate,curTime].filter(Boolean).join(' // ')||'‚Äî';
  $id('tl-date').textContent=curDate||'‚Äî';
}
function updateDlSub(){
  const n=getFilteredData().length;
  $id('dl-sub').textContent=`${n} record${n!==1?'s':''} in selected range`;
}
function buildTimeline(){
  const sl=$id('tl-slider');
  const lastIdx=Math.max(0,DATES.length-1);
  sl.max=lastIdx;sl.value=lastIdx;setSlider(lastIdx);
  if(DATES.length){
    const mid=DATES[Math.floor(DATES.length/2)];
    $id('tl-lbls').innerHTML=`<span>${DATES[0]}</span><span>${mid}</span><span>${DATES[lastIdx]}</span>`;
    $id('date-from-txt').textContent=DATES[0];
    $id('date-to-txt').textContent=DATES[lastIdx];
    calFrom=DATES[0];calTo=DATES[lastIdx];
  }
  updateDlSub();
}
function setSlider(idx){
  const pct=DATES.length>1?idx/(DATES.length-1)*100:100;
  $id('tl-slider').style.background=`linear-gradient(to right,var(--c1) 0%,var(--c1) ${pct}%,rgba(0,255,255,.08) ${pct}%)`;
}
function onSlide(idx){setSlider(idx);if(DATES[idx]){curDate=DATES[idx];updateDT();refresh();}}
function buildChips(){
  const wrap=$id('chips');wrap.innerHTML='';
  const mk=(label,time)=>{
    const c=document.createElement('button');
    c.className='chip'+(time===curTime?' on':'')+(time===null&&!curTime?' on':'');
    c.textContent=label;
    c.onclick=()=>{curTime=time;document.querySelectorAll('.chip').forEach(x=>x.classList.remove('on'));c.classList.add('on');refresh();};
    wrap.appendChild(c);
  };
  mk('ALL',null);TIMES.forEach(t=>mk(t,t));
}
function togglePlay(){
  playing=!playing;const ring=$id('play-ring');
  if(playing){
    ring.textContent='‚è∏';ring.style.borderColor='var(--c3)';ring.style.color='var(--c3)';ring.style.boxShadow='var(--glow3)';
    playTmr=setInterval(()=>{const sl=$id('tl-slider');const nx=(+sl.value+1)%DATES.length;sl.value=nx;onSlide(nx);},900);
  }else{
    ring.textContent='‚ñ∂';ring.style.borderColor='var(--c1)';ring.style.color='var(--c1)';ring.style.boxShadow='var(--glow)';
    clearInterval(playTmr);
  }
}
function setView(mode){
  viewMode=mode;
  $id('btn-heat').classList.toggle('on',mode==='heatmap');
  $id('btn-pin').classList.toggle('on',mode==='markers');
  refresh();
}
function togglePanel(id){
  const body=$id(id+'-body'),btn=$id(id+'-min');
  if(!body)return;
  const c=body.classList.toggle('collapsed');
  if(btn)btn.textContent=c?'+':'‚àí';
}
function mobToggle(id){
  const el=$id(id);if(!el)return;
  const hidden=el.style.display==='none'||el.style.display==='';
  ['stats','controls'].forEach(p=>{
    const e=$id(p);if(e)e.style.display='none';
    const mb=$id('mob-'+p);if(mb)mb.classList.remove('active');
  });
  if(hidden){el.style.display='block';const mb=$id('mob-'+id);if(mb)mb.classList.add('active');}
}
function refresh(){updateDT();const snap=getSnapshot();updateMap(snap);updateStats(snap);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODULE: download.js  ‚Äî  exports ONLY the date-filtered range
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function downloadCSV(){
  // Use only the rows within the user-selected filterFrom ‚Üí filterTo range
  const data=getFilteredData();
  if(!data.length){toast('NO DATA IN SELECTED RANGE',false);return;}
  const HDR=['Station','Date','Time','Temp(C)','RH(%)','Wind(km/h)','Rain(mm)','Pressure(hPa)','Weather'];
  const rows=data.map(r=>[
    `"${r.station}"`,r.date||'',r.time||'',
    r.temp??'',r.humidity??'',r.wind??'',r.rain??'',r.pressure??'',`"${r.weatherType||''}"`
  ].join(','));
  const csv=[HDR.join(','),...rows].join('\n');
  const url=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  Object.assign(document.createElement('a'),
    {href:url,download:`METEO_SL_${filterFrom||'all'}_to_${filterTo||'all'}.csv`}).click();
  URL.revokeObjectURL(url);
  toast(`EXPORTED ${data.length} RECORDS  //  ${filterFrom} ‚Üí ${filterTo}`,true);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const setMsg=t=>{const el=$id('load-msg');if(el)el.textContent=t;};
function toast(msg,ok=true){
  const el=$id('toast');
  el.textContent=msg;
  el.style.color=ok?'var(--c5)':'#f59e0b';
  el.style.borderColor=ok?'rgba(0,255,136,.35)':'rgba(245,158,11,.35)';
  el.style.background=ok?'rgba(0,255,136,.07)':'rgba(245,158,11,.07)';
  el.classList.add('show');setTimeout(()=>el.classList.remove('show'),4000);
}
function initMobile(){
  if(window.innerWidth<=460){
    ['stats','controls'].forEach(id=>{const e=$id(id);if(e)e.style.display='none';});
  }
}
async function init(){
  const loading=$id('loading');
  try{
    initMap();
    const usedFallback=await fetchData();
    setMsg('RENDERING NODES‚Ä¶');
    buildTimeline();buildChips();refresh();initMobile();
    loading.style.opacity='0';setTimeout(()=>{loading.style.display='none';},600);
    if(usedFallback){
      setTimeout(()=>toast('OFFLINE MODE // EMBEDDED DATASET ACTIVE',false),800);
      $id('h-src').textContent='DEMO';
      const dot=$id('h-dot');dot.style.background='#f59e0b';dot.style.boxShadow='0 0 10px #f59e0b';
    }
  }catch(err){
    console.error('[METEO] Fatal:',err);
    loading.innerHTML=`<div style="text-align:center;padding:40px;font-family:'Share Tech Mono',monospace">
      <div style="font-size:42px;margin-bottom:16px;filter:drop-shadow(0 0 10px #ff3c3c)">‚ö†</div>
      <div style="color:#ff3c3c;font-size:16px;letter-spacing:.18em;margin-bottom:10px">SYSTEM FAILURE</div>
      <div style="color:#2a7a9a;font-size:13px">${err.message}</div>
    </div>`;
  }
}
init();
</script>
</body>
</html>
